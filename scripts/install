#!/usr/bin/env bash

# We prepare the ROOT filesystem with dependencies from NPM
# Since there is no functional NPM on the system yet, we use NPM from the
# downloaded Node.js source code to install NPM packages into the container

GRN="\e[32m"
CLR="\e[0m"


BAREBONES=`pwd`/../nodeos-barebones
INITRAMFS=`pwd`/../nodeos-initramfs

NODE_DIR=$BAREBONES/deps/node

TOOLCHAIN=$BAREBONES/node_modules/nodeos-cross-toolchain
TOOLS=$TOOLCHAIN/out

source $TOOLCHAIN/scripts/adjustEnvVars.sh || exit $?


if [[ -z "$name" ]]; then name=rootfs; fi


if [[ -d $OBJECTS ]]; then
  chmod -R u+w $OBJECTS &&
  rm    -rf    $OBJECTS || exit 300
fi
mkdir -p $OBJECTS || exit 301


#
# Well-known DNS server (we do not yet support DHCP)
# VT-100 terminfo
#

mkdir -p $OBJECTS/etc              &&
cp    -f resolv.conf $OBJECTS/etc/ || exit 320

mkdir -p $OBJECTS/usr/share/terminfo/l &&
cp /usr/share/terminfo/l/linux-vt $OBJECTS/usr/share/terminfo/l/linux


#
# Wrap the system up and pack it
#

# Set rootfs files ONLY executable
chmod -R u-w,go-rw "$OBJECTS" || exit 350
chmod go+r "$OBJECTS/usr/share/terminfo/l/linux" || exit 350

case $PLATFORM in
  docker)
    docker build -t $name . || exit 351
  ;;

  pc_qemu | raspberry_qemu | raspberry_image)
    # Create the disk image

    OUT_DIR=$OUT_DIR/qemu

    # Size in MB
#    DISK_SIZE=`du -ks $OBJECTS | cut -f1`
    DISK_SIZE=$((32*1024))

    mkdir -p `dirname $OUT_DIR`
    genext2fs -b $DISK_SIZE     \
        --root $OBJECTS         \
        --reserved-percentage 0 \
        --squash-uids $OUT_DIR  || exit 352

    ln -sfv $OUT_DIR $name.img || exit 353
  ;;

  pc_image)
    # Copy kernel and initramfs on the disk image

    mkdir -p    $OBJECTS/boot/grub &&
    cp grub.cfg $OBJECTS/boot/grub || exit 354

    cp $BAREBONES/bzImage           $OBJECTS/boot/bzImage           &&
    cp $INITRAMFS/initramfs.cpio.gz $OBJECTS/boot/initramfs.cpio.gz || exit 355

    # Create the disk image

    OUT_DIR=$OUT_DIR/image

    mkdir -p `dirname $OUT_DIR`
    grub-mkrescue /usr/lib/grub/i386-pc -o $OUT_DIR $OBJECTS || exit 356
    ln -sfv $OUT_DIR $name.img                               || exit 357
  ;;
esac


echo -e "${GRN}Successfully built '$name'${CLR}"
